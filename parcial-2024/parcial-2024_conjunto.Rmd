---
title: "Parcial fundamentos"
author: "Nombres: DYLAN GABRIEL GONZALEZ SANCHEZ y GERARDO ROCHA BENIGNO"
output: html_document
---

**Entrega:** 16 de octubre antes de las 16:00 horas por Canvas.

**Instrucciones:**

* Tus respuestas deben ser claras y debes explicar 
los resultados, incluye también tus procedimientos/código de manera ordenada, 
y el código comentado.

* Se evaluará la presentación de resultados (calidad de las gráficas, tablas, 
...), revisa la sección de visualización en las notas.

* Se puede realizar individual o en parejas.

* Si tienes preguntas puedes escribirlas en el anuncio de canvas del examen, 
será el único medio para resolver dudas del examen.


```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```


## Pruebas de hipótesis

### 1. Pruebas de hipótesis: Ascorbato

Pacientes con cancer terminal avanzado en el estómago y mama se trataron con ascorbato para prolongar la supervivencia. Los datos `ascorbate` muestran 
la supervivencia en días. Trabaja con los datos en escala logarítimica.

1. Realiza una prueba de hipótesis visual para comparar las mediciones de 
los dos grupos. Describe tus conclusiones.

2. Usa una prueba de permutación para examinar la hipótesis de que no hay 
diferencia en la media de los tiempos de supervivencia. Escribe la hipóteisis nula, hipótesis alterna, y reporta el valor $p$ de la prueba.


## 2. Bootstrap: Bioequivalencia

La bioequivalencia es un término utilizado en farmacocinética para evaluar la 
equivalencia terapéutica entre dos formulaciones de un medicamento que contiene 
el mismo principio activo o fármaco. Cuando una farmacéutica cambia una fórmula 
o desarrolla una nueva presentación de un medicamento ya disponible al público, 
requiere aprobación de la FDA para poder distribuirlo, para lograr esta 
aprobación debe demostrar que el nuevo medicamento es bioequivalente al 
medicamento ya aprobado, es así que se diseñan ensayos clínicos donde se compara 
la respuesta de los participantes al recibir las distintas formulaciones del 
medicamento. 

En este ejercicio analizarás la bioequivalencia de una nueva tableta de 
Zolmitriptano de 5 mg en relación a tabletas aprobadas de 2.5 mg:

* En el ensayo clínico participaron 24 voluntarios saludables, cada uno se 
asignó de manera aleatoria para recibir la formulación de 5 mg (formulación a 
prueba) o dos tabletas de 2.5 mg (formulación referencia).

* Se recolectaron muestras de sangre antes de la dosis y durante las siguientes 
24 horas. 

Realiza lo siguiente:

1. Lee los datos `zolmitriptan-raw.txt`, las variables son: 
    + `formulation` indica si la observación corresponde a formulación de 
    refernecia o de prueba, 
    + `subj` identifica al sujeto, 
    + `seq` toma dos valores 1 indica que el sujeto se evaluó tomando la 
    formulación de tratamiento primero y después la de referencia, 2 indica el 
    caso contrario,
    + `prd` indica el periodo (1 o 2), 
    + las variables `HRXX` indican la medición (concentración de Zolmitriptano en 
    mCG/ml) para la hora XX (HR00 corresponde a la hora cero, HR05 a media hora, 
    HR10 a una hora,..., HR240 a 24 horas). 
    Desafortunadamente estos datos crudos están truncados y para algunos sujetos
(1, 3, 5, 8, 9, 12, 16, 17, 19, 22, 23) no tenemos las mediciones del tratamiento 
de referencia, sin embargo, podemos usar la información disponible para entender
como se calculan las métricas.

```{r}
zolmitriptan_raw <- read_delim("datos/zolmitriptan-raw.txt", 
    "\t", escape_double = FALSE, trim_ws = TRUE)
```

1. Grafica la concentración del medicamento por hora. Debes graficar en el eje 
horizontal la hora, en el eje vertical la concentración para cada persona, bajo 
cada tratamiento. Un ejemplo de lo que debes hacer  es [esta gráfica](https://en.wikipedia.org/wiki/Bioequivalence#/media/File:Bupropion_bioequivalency_comparison.svg),
con la diferencia que la curva de Wikipedia es el promedio sobre todos los individuos y 
tu graficarás una para cada uno. ¿Qué puedes ver en las gráficas?


```{r, fig.width=20, fig.height=15}
# Pivoteamos para tener un dataframe que podamos gráficar.
zolmitriptan <- zolmitriptan_raw |> pivot_longer(cols = c(starts_with("HR")), names_prefix = "HR",  names_to = "hora", values_to =  "concentracion") |> 
  mutate(hora = as.numeric(hora)/10,
         formulation = if_else(formulation=="T", "Prueba", "Referencia"))

ggplot(zolmitriptan, aes(x = hora, y = concentracion, group = formulation, colour = formulation)) +
  geom_line() + 
  labs(title="Concentración de Zolmitriptano en la sangre para diversos individuos",x="Tiempo transcurrido desde la toma de la dosis (horas)", y ="Zolmitriptano (mCG/ml)") +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme_bw(base_size = 15) +
  theme(strip.text = element_text(size = 12)) + 
  facet_wrap(~subj, ncol = 6, scales="free") 
```

Para comprobar bioequivalencia la FDA solicita que el medicamento de prueba 
tenga un comportamiento similar al del medicamento de referencia. Para ello se
compara la máxima concentración de medicamento (CMAX), el tiempo que tarda el 
individuo en alcanzar las concentración máxima en sangre (TMAX), y el área bajo 
la curva de concentración contra tiempofci (AUC, que acabas de graficar). En 
particular para que la FDA concluya bioequivalencia se requiere que para cada 
medición (CMAX, TMAX y AUC) un intervalo de 90% de confianza para el cociente 
$\mu_T/\mu_R$ de la media del tratamiento de prueba $\mu_T$ y la media de la 
referencia $\mu_R$ esté contenido en el intervalo $(80\%, 125\%)$. En este 
ejercicio usarás bootstrap para calcular un intervalo de confianza para el 
cociente de las medias de AUC. 

2. Calcula el AUC para cada individuo en cada tratamiento disponible, usa la 
fórmula de área trapezoidal:
$$AUC = \sum_{\tau=1}^k(c_\tau + c_{\tau−1}) × (t_\tau − t_{\tau-1}) / 2$$ donde 
$c$ es la concentración y $t$ son las horas. Tip: Si usas las funciones de dplyr 
puede resultar útil usar `lag()`. Presenta una tabla con tus resultados.

```{r}
library(gt)
auc <- zolmitriptan |>
  select(subj, formulation, hora, concentracion) |> 
  group_by(subj, formulation) |> 
  mutate(hora_base = hora - lag(hora),
         concentracion_altura = (concentracion+lag(concentracion))/2,
         base_altura = hora_base*concentracion_altura) |>
  summarize(auc= sum(base_altura, na.rm=TRUE))

aux <- auc |> 
  pivot_wider(names_from = "formulation", values_from = "auc") |>
  arrange(subj) |>
  mutate(Sujeto = as.character(subj),
         Prueba = as.character(round(Prueba,1)),
         Prueba = replace_na(Prueba, "N/A"),
         Referencia = as.character(round(Referencia,1)),
         Referencia = replace_na(Referencia, "N/A")
         ) |>
  ungroup()

```

```{r}
aux |>
  select(Sujeto, Prueba, Referencia) |>
  gt() |>
  tab_header(title = "Área bajo la curva para las pruebas de bioequivalencia de una nueva formulación de Zolmitriptan") |>
  cols_label(Sujeto = "Sujeto",
             Prueba = "Formulación de Prueba",
              Referencia = "Formulación de Referencia") |>
  tab_style(style = cell_borders(sides = "all",
                                 color = "gray",
                                 weight = px(1)),
            locations = cells_body()) |>
  cols_align(align = "center",
             columns = everything()) |>
  cols_width(everything() ~ px(150)) |>
  tab_options(table.width = pct(100),
              table.font.size = px(14))
```


Para los siguientes incisos usa los datos zolmitriptan.csv, 
para el $i$-ésimo individuo `subj` tienes mediciones de AUC bajo tratamiento y 
referencia, denotemos a este par $x_i=(auc_{Ti}, auc_{Ri})$, suponiendo que las 
$x_i$ se obuvieron de manera aleatoria de una distribución bivariada $P$, 
entonces la cantidad poblacional de interés es el parámetro 
$\theta = \mu_T/\mu_R$. 

3. Calcula el estimador *plug-in* de $\theta$.

```{r}
zol2 <- read_csv("./datos/zolmitriptan.csv", show_col_types = FALSE)

theta <- zol2 |> 
  summarize(mu_auc = sum(AUC)/n(),
            mu_cmax = sum(CMAX)/n(), 
            mu_tmax = sum(TMAX)/n(),
            .by = Formulation) |>
  pivot_wider(names_from = "Formulation", values_from = c("mu_auc", "mu_cmax", "mu_tmax")) |>
  mutate(theta_auc = mu_auc_T/mu_auc_R,
         theta_cmax = mu_cmax_T/mu_cmax_R,
         theta_tmax = mu_tmax_T/mu_tmax_R)

sprintf("Estimador plug-in de AUC (Área bajo la curva): %1.3f", theta$theta_auc)
sprintf("Estimador plug-in de CMAX (Concentración máxima): %1.3f", theta$theta_cmax)
sprintf("Estimador plug-in de TMAX (Tiempo en que se alcanzó la máxima concentración): %1.3f", theta$theta_tmax)
```


4. Usa bootstrap para generar un intervalo del 90% de confianza para $\theta$, 
¿la nueva tableta cumple el criterio de bioequivalencia de la FDA?

```{r}
set.seed(123)
dist_boot <- map_df(1:5000, 
                    ~slice_sample(zol2, prop = 1, replace = TRUE, by = Formulation) |>
                      summarize(mu_auc = sum(AUC)/n(),
                                mu_cmax = sum(CMAX)/n(),
                                mu_tmax = sum(TMAX)/n(),
                                .by = Formulation) |>
                      pivot_wider(names_from = "Formulation", values_from = c("mu_auc", "mu_cmax", "mu_tmax")) |>
                      mutate(theta_auc = mu_auc_T/mu_auc_R,
                             theta_cmax = mu_cmax_T/mu_cmax_R,
                             theta_tmax = mu_tmax_T/mu_tmax_R) |>
                      select(theta_auc, theta_cmax, theta_tmax) |>
                      mutate(iter=.x)
                    )
```

```{r, fig.width=15, fig.height=7}
library(patchwork)
dist_boot_auc  <- ggplot(dist_boot, aes(x=theta_auc)) + geom_histogram(bins = 50)  + labs(title="Dist. bootstrap de estimador de razón de AUC", x = "Estimador de razón - AUC", y = "Conteo")
dist_boot_cmax <- ggplot(dist_boot, aes(x=theta_cmax)) + geom_histogram(bins = 50) + labs(title="Dist. bootstrap de estimador de razón de CMAX", x = "Estimador de razón - CMAX", y = "Conteo")
dist_boot_tmax <- ggplot(dist_boot, aes(x=theta_tmax)) + geom_histogram(bins = 50) + labs(title="Dist. bootstrap de estimador de razón de TMAX", x = "Estimador de razón - TMAX", y = "Conteo")

qq_auc <- ggplot(dist_boot, aes(sample=theta_auc))+ stat_qq() + stat_qq_line() +labs(title="QQ de estimador de razón de AUC", y="Dist. Empírica", x="Dist. Teórica")
qq_cmax <- ggplot(dist_boot, aes(sample=theta_cmax))+ stat_qq() + stat_qq_line() +labs(title="QQ de estimador de razón de CMAX", y="Dist. Empírica", x="Dist. Teórica")
qq_tmax <- ggplot(dist_boot, aes(sample=theta_cmax))+ stat_qq() + stat_qq_line() +labs(title="QQ de estimador de razón de TMAX", y="Dist. Empírica", x="Dist. Teórica")

(dist_boot_auc + dist_boot_cmax + dist_boot_tmax) / (qq_auc + qq_cmax +qq_tmax)



```

```{r}
# AUC
print("----AUC")
sprintf("Intervalo del 90%% de confianza del estimador de rázon de AUC usando el método de percentiles: (%1.5f , %1.5f)", 
        unname(quantile(dist_boot$theta_auc, probs = c(0.05))),
        unname(quantile(dist_boot$theta_auc, probs = c(0.95)))
        )
# La dist. normal acumula el 90% de la distribución en aproximadamente 1.645 la desviación estándar alrededor de la media
sprintf("Intervalo del 90%% de confianza del estimador de rázon de AUC el método normal: (%1.5f , %1.5f)", 
        theta$theta_auc - 1.645*sd(dist_boot$theta_auc),
        theta$theta_auc + 1.645*sd(dist_boot$theta_auc)
        )
print("El intervalo de confianza bootstrap del estimador de razón de AUC se encuentra dentro de los requerimientos de la FDA")

print("----CMAX")
sprintf("Intervalo del 90%% de confianza del estimador de rázon de CMAX usando el método de percentiles: (%1.5f , %1.5f)", 
        unname(quantile(dist_boot$theta_cmax, probs = c(0.05))),
        unname(quantile(dist_boot$theta_cmax, probs = c(0.95)))
        )
# La dist. normal acumula el 90% de la distribución en aproximadamente 1.645 la desviación estándar alrededor de la media
sprintf("Intervalo del 90%% de confianza del estimador de rázon de CMAX el método normal: (%1.5f , %1.5f)", 
        theta$theta_cmax - 1.645*sd(dist_boot$theta_cmax),
        theta$theta_cmax + 1.645*sd(dist_boot$theta_cmax)
        )
print("El intervalo de confianza bootstrap del estimador de razón de CMAX se encuentra dentro de los requerimientos de la FDA")

print("----TMAX")
sprintf("Intervalo del 90%% de confianza del estimador de rázon de TMAX usando el método de percentiles: (%1.5f , %1.5f)", 
        unname(quantile(dist_boot$theta_tmax, probs = c(0.05))),
        unname(quantile(dist_boot$theta_tmax, probs = c(0.95)))
        )
# La dist. normal acumula el 90% de la distribución en aproximadamente 1.645 la desviación estándar alrededor de la media
sprintf("Intervalo del 90%% de confianza del estimador de rázon de TMAX el método normal: (%1.5f , %1.5f)", 
        theta$theta_tmax - 1.645*sd(dist_boot$theta_tmax),
        theta$theta_tmax + 1.645*sd(dist_boot$theta_tmax)
        )
print("El intervalo de confianza bootstrap del estimador de razón de TMAX se encuentra dentro de los requerimientos de la FDA")

```

### 3. Bootstrap encuestas 

En este ejercicio utilizarás la Encuesta Nacional sobre Disponibilidad y Uso de 
Tecnologías de la Información en los Hogares (ENDUTIH) para estimar a nivel nacional:

- la proporción de hogares que tienen acceso a internet.  
- la proporción de hogares con teléfono fijo.  
- la proporción de hogares con teléfono móvil.  

1. Reporta estimaciones puntuales e intervalos de confianza del 95% (utilizando bootstrap
de Rao y Wu, puedes usar los paquetes survey o srvyr).

```{r}
library(srvyr)
set.seed(123)
dic_endutih <- read_csv("./datos/endutih/diccionario_de_datos_tr_endutih_hogares_anual_2023.csv", show_col_types = FALSE)
tr_endutih <- read_csv("./datos/endutih/tr_endutih_hogares_anual_2023.csv", show_col_types = FALSE)

# Transformamos tibble a tbl_svy 
endutih_design <- tr_endutih |> 
  select(UPM, FAC_HOG, EST_DIS, P4_4, P4_1_6, P5_5, ENT) |>
  mutate(con_internet = if_else(P4_4==1,1,0),
         con_movil    = if_else(P4_1_6==1,1,0),
         con_fijo     = if_else(P5_5==1,1,0)) |>
  select(UPM, FAC_HOG, EST_DIS, ENT, con_internet, con_movil, con_fijo) |>
  as_survey_design(ids = UPM, weights = FAC_HOG, strata = EST_DIS)

# Calculamos el error muestral bootstrap
endutih_boot <- endutih_design %>% 
  as_survey_rep(type = "subbootstrap", replicates = 500)

```


```{r}
# Intervalo de confianza
metricas <- endutih_boot %>% 
  srvyr::summarise(prop_internet = survey_mean(con_internet),
                   prop_movil    = survey_mean(con_movil),
                   prop_fijo    = survey_mean(con_fijo))

sprintf("Estimador puntual de la proporción de hogares con acceso a internet: %1.5f", metricas$prop_internet)
sprintf("Estimador puntual de la proporción de hogares con teléfono fijo: %1.5f", metricas$prop_fijo)
sprintf("Estimador puntual de la proporción de hogares con teléfono móvil: %1.5f", metricas$prop_movil)

sprintf("Intervalo del 95%% de confianza de la proporciòn de hogares con acceso a internet: (%1.5f, %1.5f)", 
        metricas$prop_internet-2*metricas$prop_internet_se, 
        metricas$prop_internet+2*metricas$prop_internet_se)
sprintf("Intervalo del 95%% de confianza de la proporciòn de hogares con teléfono fijo: (%1.5f, %1.5f)", 
        metricas$prop_fijo-2*metricas$prop_fijo_se, 
        metricas$prop_fijo+2*metricas$prop_fijo_se)
sprintf("Intervalo del 95%% de confianza de la proporciòn de hogares con teléfono móvil: (%1.5f, %1.5f)", 
        metricas$prop_movil-2*metricas$prop_movil_se, 
        metricas$prop_movil+2*metricas$prop_movil_se)


```

2. Elige una de las métricas de arriba y calcula intervalos de confianza por estado, 
grafica los intervalos y discute los resultados.

Utilizaremos la proporción de hogares con acceso a internet. 
- Los 5 estados con una menor proporción de hogares con acces a internet son: Chiapas (44.28%), Oaxaca (52.96%), Guerrero (53.86%), Veracruz (58.18%) y Puebla (58.33%).
- Los 5 estados con una mayor proporción de hogares con acces a internet son: Ciudad de México (89.47%), Baja California (86.44%), Quintana Roo (83.60%), Jalisco (83.34%) y Aguascalientes (81.43%).

```{r, fig.width=8, fig.height=10}
estado_internet <- endutih_boot %>% 
  group_by(ENT) %>% 
  srvyr::summarise(prop_internet = survey_mean(con_internet)) |>
  mutate(inf = prop_internet - 2* prop_internet_se,
         sup = prop_internet + 2* prop_internet_se)

estados <- read_delim("./datos/estados.txt", show_col_types = FALSE)
estado_internet_2 <- left_join(estado_internet, estados, by="ENT") |>select(nombre, inf, sup, prop_internet)


ggplot(estado_internet_2, aes(x = prop_internet, y = factor(nombre, levels = sort(nombre)), xmax = sup, xmin = inf)) + 
  geom_point(colour = "firebrick") + 
  geom_linerange() +
  geom_hline(yintercept = 0, colour = "gray") + 
  labs(title="Proporción de hogares en cada estado con acceso a internet",
       x="Proporción de hogares con acceso a internet",
       y="Estado")
```